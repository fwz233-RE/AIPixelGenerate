<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>AI å›¾åƒç”Ÿæˆå™¨ Pro (å¤šå›¾ç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --success-color: #2ecc71;
            --error-color: #e74c3c;
            --bg-color: #f5f7fa;
            --panel-bg: #ffffff;
            --text-color: #333;
            --border-color: #ddd;
        }

        html {
            height: 100%;
            /* æ”¯æŒiOSå®‰å…¨åŒºåŸŸ */
            padding-top: env(safe-area-inset-top, 0px);
            padding-left: env(safe-area-inset-left, 0px);
            padding-right: env(safe-area-inset-right, 0px);
            padding-bottom: env(safe-area-inset-bottom, 0px);
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: var(--panel-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .tag {
            background: #eee;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            color: #666;
            vertical-align: middle;
        }

        .config-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .full-width {
            grid-column: span 2;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #555;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        input[type="text"],
        input[type="password"],
        textarea {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
            box-sizing: border-box;
            width: 100%;
        }

        input:focus,
        textarea:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* --- å¤šå›¾ä¸Šä¼ åŒºåŸŸæ ·å¼ --- */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            outline: none;
            /* ç§»é™¤èšç„¦æ—¶çš„é»˜è®¤è½®å»“ */
        }

        .upload-area:hover,
        .upload-area.dragover {
            background-color: #fafafa;
            border-color: var(--primary-color);
        }

        /* é¢„è§ˆç½‘æ ¼ */
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            width: 100%;
            margin-top: 10px;
        }

        .thumb-item {
            position: relative;
            width: 100%;
            padding-top: 100%;
            /* 1:1 Aspect Ratio */
            border-radius: 6px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            background: #eee;
        }

        .thumb-item img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumb-remove {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            line-height: 20px;
            text-align: center;
            padding: 0;
            z-index: 2;
        }

        .thumb-remove:hover {
            background: rgba(255, 0, 0, 0.9);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 10px;
            width: 100%;
        }

        button:hover {
            filter: brightness(1.1);
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .action-btn {
            padding: 8px 16px;
            font-size: 14px;
            margin-top: 10px;
            width: auto;
            background-color: #6c757d;
        }

        .action-btn.loop {
            background-color: var(--success-color);
        }

        .result-area {
            margin-top: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .log-panel {
            background: #1e1e1e;
            color: #00ff00;
            font-family: 'Consolas', 'Monaco', monospace;
            padding: 15px;
            border-radius: 6px;
            height: 150px;
            overflow-y: auto;
            font-size: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .image-preview-box {
            border: 2px solid var(--border-color);
            border-radius: 8px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
            overflow: hidden;
            position: relative;
            flex-direction: column;
            padding: 20px;
        }

        .image-preview-box img {
            max-width: 100%;
            height: auto;
            display: block;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* --- å‹ç¼©å¯¹è¯æ¡†æ ·å¼ --- */
        .compress-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .compress-modal.active {
            display: flex;
        }

        .compress-dialog {
            background: var(--panel-bg);
            border-radius: 16px;
            width: 100%;
            max-width: 1100px;
            height: calc(100vh - 40px);
            max-height: 700px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .compress-header {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex-shrink: 0;
        }

        .compress-header h2 {
            margin: 0;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .compress-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 12px 15px;
            gap: 10px;
            min-height: 0;
        }

        /* æ§åˆ¶é¢æ¿ */
        .compress-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 10px 15px;
            flex-shrink: 0;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-group label span {
            background: var(--primary-color);
            color: white;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-container input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #e74c3c 0%, #f39c12 50%, #2ecc71 100%);
            outline: none;
        }

        .slider-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--primary-color);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        /* å°ºå¯¸é¢„è®¾æŒ‰é’® */
        .size-presets {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 6px 12px !important;
            font-size: 12px !important;
            width: auto !important;
            margin: 0 !important;
            background: #e9ecef !important;
            color: #495057 !important;
            border-radius: 20px !important;
            transition: all 0.2s !important;
        }

        .preset-btn:hover {
            background: var(--primary-color) !important;
            color: white !important;
        }

        .preset-btn.active {
            background: var(--primary-color) !important;
            color: white !important;
        }

        /* å¯¹æ¯”åŒºåŸŸ */
        .compare-container {
            flex: 1;
            display: flex;
            gap: 10px;
            min-height: 0;
            overflow: hidden;
        }

        .compare-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            background: #fafafa;
        }

        .compare-panel.original {
            border-color: #e74c3c;
        }

        .compare-panel.compressed {
            border-color: #2ecc71;
        }

        .panel-header {
            padding: 6px 12px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            flex-shrink: 0;
        }

        .compare-panel.original .panel-header {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .compare-panel.compressed .panel-header {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
        }

        .size-badge {
            background: rgba(255, 255, 255, 0.25);
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .image-viewport {
            flex: 1;
            overflow: hidden;
            position: relative;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            background: repeating-clamped-gradient(45deg, #f0f0f0, #f0f0f0 10px, #e8e8e8 10px, #e8e8e8 20px);
            background:
                linear-gradient(45deg, #e8e8e8 25%, transparent 25%),
                linear-gradient(-45deg, #e8e8e8 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #e8e8e8 75%),
                linear-gradient(-45deg, transparent 75%, #e8e8e8 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #f5f5f5;
        }

        .image-viewport:active {
            cursor: grabbing;
        }

        .image-viewport img {
            transform-origin: center center;
            transition: none;
            max-width: none;
            max-height: none;
            pointer-events: none;
            image-rendering: auto;
            user-select: none;
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
        }

        /* ç¼©æ”¾æ§åˆ¶ */
        .zoom-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 6px 10px;
            background: #f8f9fa;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .zoom-btn {
            width: 28px !important;
            height: 28px !important;
            padding: 0 !important;
            margin: 0 !important;
            border-radius: 50% !important;
            font-size: 16px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            background: var(--primary-color) !important;
        }

        .zoom-level {
            min-width: 60px;
            text-align: center;
            font-weight: 600;
            color: #555;
        }

        .sync-zoom-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #e9ecef;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85em;
            user-select: none;
        }

        .sync-zoom-toggle input {
            accent-color: var(--primary-color);
        }

        .sync-zoom-toggle.active {
            background: var(--primary-color);
            color: white;
        }

        /* åº•éƒ¨æ“ä½œæ  */
        .compress-footer {
            padding: 10px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            flex-shrink: 0;
        }

        .compression-stats {
            display: flex;
            gap: 20px;
            font-size: 0.85em;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .stat-label {
            color: #888;
            font-size: 0.85em;
        }

        .stat-value {
            font-weight: 700;
            color: #333;
        }

        .stat-value.savings {
            color: #2ecc71;
        }

        .footer-buttons {
            display: flex;
            gap: 10px;
        }

        .footer-buttons button {
            width: auto !important;
            margin: 0 !important;
            padding: 8px 20px !important;
            font-size: 14px !important;
        }

        .btn-cancel {
            background: #6c757d !important;
        }

        .btn-confirm {
            background: linear-gradient(135deg, #2ecc71, #27ae60) !important;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            .config-section {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .full-width {
                grid-column: span 1;
            }

            input[type="text"],
            input[type="password"],
            textarea {
                padding: 10px;
                font-size: 16px; /* é˜²æ­¢iOSç¼©æ”¾ */
                box-sizing: border-box;
                width: 100%;
            }

            h1 {
                font-size: 1.5em;
            }

            .upload-area {
                min-height: 120px;
            }

            .log-panel {
                height: 120px;
                font-size: 11px;
            }

            .aod-text-block {
                font-size: 16px;
                padding: 8px;
            }

            /* å‹ç¼©å¯¹è¯æ¡†ç§»åŠ¨ç«¯ä¼˜åŒ– */
            .compress-dialog {
                max-width: 100%;
                max-height: 90vh;
                margin: 10px;
                border-radius: 12px;
            }

            .compress-header {
                padding: 10px 15px;
            }

            .compress-header h2 {
                font-size: 1.1em;
            }

            .compress-controls {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 12px;
            }

            .control-group label {
                font-size: 0.9em;
            }

            .size-presets {
                display: flex;
                flex-wrap: wrap;
                gap: 6px;
                margin-top: 8px;
            }

            .preset-btn {
                flex: 1;
                min-width: 60px;
                padding: 6px 8px;
                font-size: 12px;
            }

            .compare-container {
                flex-direction: column;
                height: 40vh;
            }

            .compare-panel {
                flex: 1;
                min-height: 0;
            }

            .panel-header {
                padding: 8px 12px;
                font-size: 0.9em;
            }

            .size-badge {
                font-size: 0.8em;
                padding: 2px 6px;
            }

            .zoom-controls {
                padding: 8px;
                flex-wrap: wrap;
                gap: 6px;
            }

            .zoom-btn {
                padding: 6px 10px;
                font-size: 14px;
            }

            .zoom-level {
                font-size: 0.9em;
            }

            .sync-zoom-toggle {
                font-size: 0.8em;
                margin-left: auto;
            }

            .compress-footer {
                padding: 10px 15px;
                flex-direction: column;
                gap: 12px;
            }

            .compression-stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }

            .stat-item {
                flex-direction: column;
                align-items: center;
                gap: 4px;
            }

            .stat-label {
                font-size: 0.8em;
            }

            .stat-value {
                font-size: 0.9em;
            }

            .footer-buttons {
                display: flex;
                gap: 10px;
            }

            .btn-cancel,
            .btn-confirm {
                flex: 1;
                padding: 10px;
                font-size: 0.9em;
            }
        }

        /* é’ˆå¯¹è¶…å°å±å¹•çš„ä¼˜åŒ– */
        @media (max-width: 400px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 10px;
            }

            .config-section {
                gap: 10px;
            }

            input[type="text"],
            input[type="password"],
            textarea {
                padding: 8px;
            }
        }

        /* AOD æ¨¡å¼æ ·å¼ */
        .aod-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #000000;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Courier New', monospace;
            color: #00ff00;
            overflow: hidden;
            cursor: pointer;
            box-sizing: border-box;
            padding-top: env(safe-area-inset-top, 0px);
            padding-left: env(safe-area-inset-left, 0px);
            padding-right: env(safe-area-inset-right, 0px);
            padding-bottom: env(safe-area-inset-bottom, 0px);
        }

        .aod-text-block {
            position: absolute;
            white-space: pre;
            font-size: 14px;
            line-height: 1.2;
            text-shadow: 0 0 3px #00ff00;
            padding: 6px 8px;
            border: 1px solid #00ff00;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 3px;
            transition: transform 0.1s linear;
            will-change: transform;
        }

        .aod-time-display {
            position: absolute;
            top: -20px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 10px;
            color: #00ff00;
            text-shadow: 0 0 2px #00ff00;
            opacity: 0.8;
            pointer-events: none;
            white-space: nowrap;
        }
    </style>

    <!-- PWA å’Œå›¾æ ‡é…ç½® -->
    <link rel="icon" href="icon.PNG" type="image/png">
    <link rel="apple-touch-icon" href="icon.PNG">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#4a90e2">
    <link rel="manifest" href="manifest.json">
</head>

<body>

    <div class="container">
        <h1>ğŸ¨ AI å›¾åƒç”Ÿæˆå™¨ Pro <span class="tag">Max 6å›¾ç‰ˆ</span></h1>

        <div class="config-section">
            <div class="input-group">
                <label for="baseUrl">API Base URL</label>
                <input type="text" id="baseUrl" placeholder="ä¾‹å¦‚: https://521api.com" onchange="saveConfig()">
            </div>
            <div class="input-group">
                <label for="apiKey">API Key (sk-...)</label>
                <input type="password" id="apiKey" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„ sk- å¯†é’¥" onchange="saveConfig()">
            </div>
            <div class="input-group full-width">
                <label for="modelName">æ¨¡å‹åç§° (Model)</label>
                <input type="text" id="modelName" placeholder="ä¾‹å¦‚: gemini-3-pro-image-preview-4k"
                    onchange="saveConfig()">
            </div>
        </div>

        <div class="input-group">
            <label>
                å‚è€ƒå›¾ç‰‡ (æœ€å¤š6å¼ ) - æ”¯æŒæ‹–æ‹½æˆ–Ctrl+Vç²˜è´´
                <span id="imgCountBadge" class="tag" style="background:#ddd; color:#333;">0 / 6</span>
            </label>

            <div class="upload-area" id="dropZone" onclick="triggerFileInput()" tabindex="0">
                <input type="file" id="fileInput" accept="image/*" multiple style="display: none;"
                    onchange="handleFileSelect(event)">

                <div id="uploadPlaceholder">
                    <p style="margin:0; color:#888; font-size:1.1em;">ç‚¹å‡»ã€æ‹–æ‹½æˆ–ç²˜è´´(Ctrl+V)ä¸Šä¼ å›¾ç‰‡</p>
                    <p style="margin:5px 0 0 0; color:#aaa; font-size:0.8em;">æ”¯æŒå¤šé€‰ï¼Œæœ€å¤š6å¼ </p>
                </div>

                <div class="preview-grid" id="previewGrid"></div>
            </div>
        </div>

        <div class="input-group">
            <label for="prompt">æç¤ºè¯ (Prompt)</label>
            <textarea id="prompt" placeholder="æè¿°ä½ æƒ³ç”Ÿæˆçš„å›¾ç‰‡å†…å®¹..." onchange="saveConfig()"></textarea>
        </div>

        <button id="generateBtn" onclick="generateImage()">ğŸš€ å¼€å§‹ç”Ÿæˆå›¾ç‰‡</button>

        <div class="result-area">
            <div class="input-group">
                <label>è¿è¡Œæ—¥å¿—</label>
                <div id="logConsole" class="log-panel"></div>
            </div>

            <div class="input-group">
                <label>ç”Ÿæˆç»“æœ</label>
                <div class="image-preview-box" id="resultBox">
                    <div class="loading-spinner" id="spinner"></div>
                    <span id="placeholderText" style="color: #999;">å›¾ç‰‡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</span>
                    <img id="resultImage" style="display:none;">

                    <button id="loopBtn" class="action-btn loop" onclick="useResultAsSource()" style="display:none;">
                        ğŸ”„ æ¸…ç©ºå½“å‰å‚è€ƒå›¾å¹¶å°†æ­¤å›¾æ·»åŠ 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å‹ç¼©å¯¹è¯æ¡† -->
    <div class="compress-modal" id="compressModal">
        <div class="compress-dialog">
            <div class="compress-header">
                <h2>ğŸ—œï¸ å›¾ç‰‡å‹ç¼©è®¾ç½®</h2>
                <button class="close-btn" onclick="closeCompressModal()">Ã—</button>
            </div>

            <div class="compress-body">
                <!-- æ§åˆ¶é¢æ¿ -->
                <div class="compress-controls">
                    <div class="control-group">
                        <label>
                            å‹ç¼©è´¨é‡ (Quality)
                            <span id="qualityValue">95%</span>
                        </label>
                        <div class="slider-container">
                            <input type="range" id="qualitySlider" min="10" max="100" value="95"
                                oninput="updateCompression()">
                        </div>
                    </div>

                    <div class="control-group">
                        <label>
                            æœ€å¤§å°ºå¯¸ (Max Size)
                            <span id="sizeValue">1024px</span>
                        </label>
                        <div class="slider-container">
                            <input type="range" id="sizeSlider" min="256" max="4096" value="1024" step="1"
                                oninput="updateCompression()">
                        </div>
                        <div class="size-presets">
                            <button class="preset-btn" onclick="setSizePreset(512)">512px</button>
                            <button class="preset-btn" onclick="setSizePreset(768)">768px</button>
                            <button class="preset-btn" onclick="setSizePreset(1024)">1024px</button>
                            <button class="preset-btn" onclick="setSizePreset(1536)">1536px</button>
                            <button class="preset-btn" onclick="setSizePreset(2048)">2048px</button>
                            <button class="preset-btn active" id="originalSizeBtn"
                                onclick="setSizePreset('original')">åŸå°ºå¯¸</button>
                        </div>
                    </div>
                </div>

                <!-- å¯¹æ¯”åŒºåŸŸ -->
                <div class="compare-container">
                    <div class="compare-panel original">
                        <div class="panel-header">
                            ğŸ“· åŸå§‹å›¾ç‰‡
                            <span class="size-badge" id="originalSize">-- KB</span>
                        </div>
                        <div class="image-viewport" id="originalViewport">
                            <img id="originalPreview" alt="åŸå›¾">
                        </div>
                    </div>

                    <div class="compare-panel compressed">
                        <div class="panel-header">
                            ğŸ—œï¸ å‹ç¼©å
                            <span class="size-badge" id="compressedSize">-- KB</span>
                        </div>
                        <div class="image-viewport" id="compressedViewport">
                            <img id="compressedPreview" alt="å‹ç¼©å">
                        </div>
                    </div>
                </div>

                <!-- ç¼©æ”¾æ§åˆ¶ -->
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="adjustZoom(-0.25)">âˆ’</button>
                    <span class="zoom-level" id="zoomLevel">100%</span>
                    <button class="zoom-btn" onclick="adjustZoom(0.25)">+</button>
                    <button class="zoom-btn" onclick="resetZoom()"
                        style="width: auto !important; padding: 0 12px !important; font-size: 12px !important;">é€‚åº”</button>
                    <button class="zoom-btn" onclick="setZoom(1)"
                        style="width: auto !important; padding: 0 12px !important; font-size: 12px !important;">1:1</button>
                    <label class="sync-zoom-toggle active" id="syncToggle">
                        <input type="checkbox" checked onchange="toggleSyncZoom()"> åŒæ­¥ç¼©æ”¾/æ‹–æ‹½
                    </label>
                </div>
            </div>

            <div class="compress-footer">
                <div class="compression-stats">
                    <div class="stat-item">
                        <span class="stat-label">åŸå§‹å°ºå¯¸</span>
                        <span class="stat-value" id="statOriginalDim">-- Ã— --</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">å‹ç¼©å°ºå¯¸</span>
                        <span class="stat-value" id="statCompressedDim">-- Ã— --</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">ä½“ç§¯èŠ‚çœ</span>
                        <span class="stat-value savings" id="statSavings">--%</span>
                    </div>
                </div>
                <div class="footer-buttons">
                    <button class="btn-cancel" onclick="cancelAndAddOriginal()">å–æ¶ˆ (ä½¿ç”¨åŸå›¾)</button>
                    <button class="btn-confirm" onclick="confirmCompression()">âœ“ ç¡®è®¤ä½¿ç”¨å‹ç¼©å›¾</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. æŒä¹…åŒ–å­˜å‚¨ ---
        const CONFIG_KEYS = { BASE_URL: 'ai_gen_base_url', API_KEY: 'ai_gen_api_key', MODEL: 'ai_gen_model', PROMPT: 'ai_gen_prompt' };

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('baseUrl').value = localStorage.getItem(CONFIG_KEYS.BASE_URL) || 'https://521api.com';
            document.getElementById('apiKey').value = localStorage.getItem(CONFIG_KEYS.API_KEY) || '';
            document.getElementById('modelName').value = localStorage.getItem(CONFIG_KEYS.MODEL) || 'gemini-3-pro-image-preview-4k';
            document.getElementById('prompt').value = localStorage.getItem(CONFIG_KEYS.PROMPT) || 'ç”ŸæˆçœŸäººcoseræ‰®æ¼”è¯¥è§’è‰²çš„å…¨èº«ç…§ç‰‡ã€‚\n\nè¦æ±‚ï¼šç¢å‰ªå±‚æ¬¡æ„Ÿåˆ˜æµ·ï¼ŒæŸ”è½¯å‘è´¨ï¼Œå‘ä¸ç»†èŠ‚ï¼ŒçœŸå®å‘è´¨çº¹ç†ï¼Œå‘ç¼•åˆ†æ˜ï¼ŒåŠ¨æ€æ„Ÿå‘ä¸ï¼Œé£˜é€¸å‘å‹ã€‚\nä¿æŒåŸå‘å‹ã€åŠ¨ä½œã€ç³è‰²åŠè¡¨æƒ…ã€‚\nçœŸå®äººç±»ï¼ŒçœŸå®ç‰©ç†ä¸–ç•Œçš„å…‰ç…§ä¸ç¯å¢ƒ\nå¿½ç•¥æ‰€æœ‰æ–‡å­—';
            log("ç³»ç»Ÿå°±ç»ªï¼Œé…ç½®å·²åŠ è½½ã€‚");

            // æ³¨å†Œå…¨å±€ç²˜è´´äº‹ä»¶ç›‘å¬å™¨
            document.addEventListener('paste', handlePaste);
        });

        function saveConfig() {
            localStorage.setItem(CONFIG_KEYS.BASE_URL, document.getElementById('baseUrl').value);
            localStorage.setItem(CONFIG_KEYS.API_KEY, document.getElementById('apiKey').value);
            localStorage.setItem(CONFIG_KEYS.MODEL, document.getElementById('modelName').value);
            localStorage.setItem(CONFIG_KEYS.PROMPT, document.getElementById('prompt').value);
        }

        // --- 2. å¤šå›¾å¤„ç†é€»è¾‘ ---
        let referenceImages = []; // å­˜å‚¨æ‰€æœ‰å›¾ç‰‡çš„ Base64 æ•°ç»„
        const MAX_IMAGES = 6;

        function triggerFileInput() {
            // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸è§¦å‘æ–‡ä»¶é€‰æ‹©
            document.getElementById('fileInput').click();
        }

        function handleFileSelect(event) {
            processFiles(event.target.files);
            // é‡ç½® inputï¼Œå¦åˆ™é€‰åŒåæ–‡ä»¶ä¸è§¦å‘ change
            event.target.value = '';
        }

        // --- æ–°å¢ï¼šå¤„ç†ç²˜è´´äº‹ä»¶ ---
        function handlePaste(event) {
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            let files = [];
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    const blob = item.getAsFile();
                    files.push(blob);
                }
            }
            if (files.length > 0) {
                log("æ£€æµ‹åˆ°å‰ªè´´æ¿å›¾ç‰‡ï¼Œæ­£åœ¨å¤„ç†...", 'info');
                processFiles(files);
                // æ»šåŠ¨åˆ°ä¸Šä¼ åŒºåŸŸï¼Œç»™ç”¨æˆ·è§†è§‰åé¦ˆ
                document.getElementById('dropZone').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
        // -----------------------

        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files) processFiles(e.dataTransfer.files);
        });

        // --- å‹ç¼©ç›¸å…³å˜é‡ ---
        let pendingFiles = []; // å¾…å¤„ç†çš„æ–‡ä»¶é˜Ÿåˆ—
        let currentFileIndex = 0;
        let currentOriginalBase64 = null;
        let currentCompressedBase64 = null;
        let originalImageObj = null;
        let compressedImageObj = null;

        // ç¼©æ”¾å’Œæ‹–æ‹½çŠ¶æ€
        let currentZoom = 1;
        let syncZoomEnabled = true;
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let panOffset = { x: 0, y: 0 };

        function processFiles(files) {
            if (!files || files.length === 0) return;

            // è¿‡æ»¤æœ‰æ•ˆæ–‡ä»¶
            const validFiles = Array.from(files).filter(file => {
                if (referenceImages.length >= MAX_IMAGES) {
                    log(`å·²è¾¾åˆ°${MAX_IMAGES}å¼ ä¸Šé™`, 'warn');
                    return false;
                }
                if (!file.type.startsWith('image/')) {
                    log(`è·³è¿‡éå›¾ç‰‡æ–‡ä»¶: ${file.name}`, 'warn');
                    return false;
                }
                return true;
            });

            if (validFiles.length === 0) return;

            // è®¾ç½®å¾…å¤„ç†é˜Ÿåˆ—
            pendingFiles = validFiles;
            currentFileIndex = 0;

            // å¤„ç†ç¬¬ä¸€ä¸ªæ–‡ä»¶
            processNextFile();
        }

        function processNextFile() {
            if (currentFileIndex >= pendingFiles.length) {
                pendingFiles = [];
                return;
            }

            const file = pendingFiles[currentFileIndex];
            const reader = new FileReader();

            reader.onload = (e) => {
                currentOriginalBase64 = e.target.result;
                openCompressModal(currentOriginalBase64);
            };

            reader.readAsDataURL(file);
        }

        // --- å‹ç¼©å¯¹è¯æ¡†æ§åˆ¶ ---
        function openCompressModal(base64) {
            const modal = document.getElementById('compressModal');
            const originalImg = document.getElementById('originalPreview');

            // é‡ç½®çŠ¶æ€
            currentZoom = 1;
            panOffset = { x: 0, y: 0 };

            // åŠ è½½åŸå›¾
            originalImageObj = new Image();
            originalImageObj.onload = () => {
                originalImg.src = base64;

                // ä¿å­˜åŸå›¾çš„æœ€å¤§è¾¹é•¿
                originalMaxDimension = Math.max(originalImageObj.width, originalImageObj.height);

                // æ›´æ–°æ»‘å—çš„æœ€å¤§å€¼ä»¥æ”¯æŒåŸå°ºå¯¸
                const sizeSlider = document.getElementById('sizeSlider');
                sizeSlider.max = originalMaxDimension;

                // è°ƒæ•´æœ€å°å€¼ï¼Œç¡®ä¿åŸå§‹å°ºå¯¸å¯é€‰æ‹©
                if (originalMaxDimension < 256) {
                    sizeSlider.min = Math.max(64, Math.floor(originalMaxDimension / 4));
                }

                // è®¾ç½®æ­¥é•¿ä¸º1ï¼Œç¡®ä¿åŸå§‹å°ºå¯¸å¯ä»¥ç²¾ç¡®é€‰æ‹©
                sizeSlider.step = 1;

                // è®¾ç½®é»˜è®¤ä½¿ç”¨åŸå°ºå¯¸
                sizeSlider.value = originalMaxDimension;

                // è®¡ç®—åŸå›¾å¤§å°
                const originalSizeKB = Math.round((base64.length * 3 / 4) / 1024);
                document.getElementById('originalSize').textContent = formatSize(originalSizeKB * 1024);
                document.getElementById('statOriginalDim').textContent = `${originalImageObj.width} Ã— ${originalImageObj.height}`;

                // è§¦å‘å‹ç¼©é¢„è§ˆ
                updateCompression();

                // åˆå§‹åŒ–è§†å£
                setTimeout(() => {
                    resetZoom();
                    setupViewportInteractions();
                }, 100);
            };
            originalImageObj.src = base64;

            modal.classList.add('active');
        }

        function closeCompressModal() {
            const modal = document.getElementById('compressModal');
            modal.classList.remove('active');

            // å¦‚æœæ˜¯å›ç¯æ¨¡å¼è¢«å–æ¶ˆï¼Œé‡ç½®æ ‡å¿—
            if (isLoopMode) {
                isLoopMode = false;
                return; // å›ç¯æ¨¡å¼ä¸å¤„ç†æ–‡ä»¶é˜Ÿåˆ—
            }

            // ç§»åˆ°ä¸‹ä¸€ä¸ªæ–‡ä»¶
            currentFileIndex++;
            processNextFile();
        }

        // å–æ¶ˆå‹ç¼©ä½†ç›´æ¥æ·»åŠ åŸå›¾
        function cancelAndAddOriginal() {
            // æ£€æŸ¥æ˜¯å¦ä¸ºå›ç¯æ¨¡å¼
            if (isLoopMode) {
                // å›ç¯æ¨¡å¼ï¼šæ¸…ç©ºåˆ—è¡¨åæ·»åŠ 
                referenceImages = [];
                log("å·²æ¸…ç©ºæ—§å‚è€ƒå›¾åˆ—è¡¨ã€‚", 'warn');
                isLoopMode = false; // é‡ç½®æ ‡å¿—
            } else if (referenceImages.length >= MAX_IMAGES) {
                log(`å·²è¾¾åˆ°${MAX_IMAGES}å¼ ä¸Šé™`, 'warn');
                closeCompressModal();
                return;
            }

            // ä½¿ç”¨åŸå§‹å›¾ç‰‡ï¼ˆä¸å‹ç¼©ï¼‰
            if (currentOriginalBase64) {
                referenceImages.push(currentOriginalBase64);
                renderPreviews();
                log(`å›¾ç‰‡æ·»åŠ æˆåŠŸ (åŸå›¾ï¼Œæœªå‹ç¼©)`);
            }

            // å…³é—­å¯¹è¯æ¡†
            const modal = document.getElementById('compressModal');
            modal.classList.remove('active');

            // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªæ–‡ä»¶
            currentFileIndex++;
            processNextFile();
        }

        function confirmCompression() {
            // æ£€æŸ¥æ˜¯å¦ä¸ºå›ç¯æ¨¡å¼
            if (isLoopMode) {
                // å›ç¯æ¨¡å¼ï¼šæ¸…ç©ºåˆ—è¡¨åæ·»åŠ 
                referenceImages = [];
                log("å·²æ¸…ç©ºæ—§å‚è€ƒå›¾åˆ—è¡¨ã€‚", 'warn');
                isLoopMode = false; // é‡ç½®æ ‡å¿—
            } else if (referenceImages.length >= MAX_IMAGES) {
                log(`å·²è¾¾åˆ°${MAX_IMAGES}å¼ ä¸Šé™`, 'warn');
                closeCompressModal();
                return;
            }

            // ä½¿ç”¨å‹ç¼©åçš„å›¾ç‰‡
            const imageToAdd = currentCompressedBase64 || currentOriginalBase64;
            referenceImages.push(imageToAdd);
            renderPreviews();

            if (isLoopMode === false && pendingFiles.length === 0) {
                log("ğŸ”„ å›ç¯æˆåŠŸï¼ç»“æœå›¾å·²æˆä¸ºå”¯ä¸€çš„å‚è€ƒå›¾ã€‚", 'success');
                // æ»šåŠ¨å›é¡¶éƒ¨
                document.querySelector('.config-section').scrollIntoView({ behavior: 'smooth' });
            } else {
                log(`å›¾ç‰‡æ·»åŠ æˆåŠŸ (å‹ç¼©å)`);
            }

            closeCompressModal();
        }

        // --- å‹ç¼©é€»è¾‘ ---
        let compressionDebounce = null;

        // ä¿å­˜åŸå›¾çš„æœ€å¤§è¾¹é•¿ï¼Œç”¨äº"åŸå°ºå¯¸"åŠŸèƒ½
        let originalMaxDimension = 4096;

        function updateCompression() {
            const quality = parseInt(document.getElementById('qualitySlider').value);
            const maxSize = parseInt(document.getElementById('sizeSlider').value);

            document.getElementById('qualityValue').textContent = `${quality}%`;

            // æ£€æŸ¥æ˜¯å¦ä¸ºåŸå°ºå¯¸
            const isOriginalSize = originalImageObj && maxSize >= originalMaxDimension;
            document.getElementById('sizeValue').textContent = isOriginalSize ? `åŸå°ºå¯¸` : `${maxSize}px`;

            // æ›´æ–°é¢„è®¾æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.id === 'originalSizeBtn') {
                    if (isOriginalSize) btn.classList.add('active');
                } else {
                    const presetSize = parseInt(btn.textContent);
                    if (presetSize === maxSize && !isOriginalSize) {
                        btn.classList.add('active');
                    }
                }
            });

            // é˜²æŠ–å¤„ç†
            clearTimeout(compressionDebounce);
            compressionDebounce = setTimeout(() => {
                performCompression(quality / 100, maxSize);
            }, 150);
        }

        function setSizePreset(size) {
            if (size === 'original') {
                // ä½¿ç”¨åŸå›¾çš„æœ€å¤§è¾¹é•¿
                document.getElementById('sizeSlider').value = originalMaxDimension;
                // è‡ªåŠ¨å°†è´¨é‡è®¾ä¸º100%ï¼Œç¡®ä¿ä½¿ç”¨åŸå§‹å›¾ç‰‡
                document.getElementById('qualitySlider').value = 100;
            } else {
                document.getElementById('sizeSlider').value = size;
            }
            updateCompression();
        }

        function performCompression(quality, maxSize) {
            if (!originalImageObj) return;

            // æ£€æŸ¥æ˜¯å¦ä¸éœ€è¦å¤„ç†ï¼šè´¨é‡100%ä¸”å°ºå¯¸ä¸ºåŸå°ºå¯¸
            if (quality >= 0.999 && maxSize >= originalMaxDimension && currentOriginalBase64) {
                // ç›´æ¥ä½¿ç”¨åŸå§‹å›¾ç‰‡
                currentCompressedBase64 = currentOriginalBase64;
                compressedWidth = originalImageObj.width;
                compressedHeight = originalImageObj.height;

                // æ›´æ–°å‹ç¼©åé¢„è§ˆ
                const compressedImg = document.getElementById('compressedPreview');
                compressedImg.src = currentCompressedBase64;

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                const originalSizeBytes = (currentOriginalBase64.length * 3 / 4);
                const compressedSizeBytes = originalSizeBytes;
                const savings = 0; // æ— èŠ‚çœ

                document.getElementById('compressedSize').textContent = formatSize(compressedSizeBytes);
                document.getElementById('statCompressedDim').textContent = `${compressedWidth} Ã— ${compressedHeight}`;
                document.getElementById('statSavings').textContent = `${savings}%`;

                // åº”ç”¨å½“å‰ç¼©æ”¾
                applyTransform();
                return;
            }

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            // è®¡ç®—æ–°å°ºå¯¸
            let newWidth = originalImageObj.width;
            let newHeight = originalImageObj.height;

            if (newWidth > maxSize || newHeight > maxSize) {
                if (newWidth > newHeight) {
                    newHeight = Math.round(newHeight * (maxSize / newWidth));
                    newWidth = maxSize;
                } else {
                    newWidth = Math.round(newWidth * (maxSize / newHeight));
                    newHeight = maxSize;
                }
            }

            canvas.width = newWidth;
            canvas.height = newHeight;

            // é«˜è´¨é‡ç¼©æ”¾
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(originalImageObj, 0, 0, newWidth, newHeight);

            // å‹ç¼©ä¸º JPEG
            currentCompressedBase64 = canvas.toDataURL('image/jpeg', quality);

            // æ›´æ–°å‹ç¼©åé¢„è§ˆ
            const compressedImg = document.getElementById('compressedPreview');
            compressedImg.src = currentCompressedBase64;

            // ä¿å­˜å‹ç¼©åçš„å°ºå¯¸
            compressedWidth = newWidth;
            compressedHeight = newHeight;

            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            const originalSizeBytes = (currentOriginalBase64.length * 3 / 4);
            const compressedSizeBytes = (currentCompressedBase64.length * 3 / 4);
            const savings = Math.round((1 - compressedSizeBytes / originalSizeBytes) * 100);

            document.getElementById('compressedSize').textContent = formatSize(compressedSizeBytes);
            document.getElementById('statCompressedDim').textContent = `${newWidth} Ã— ${newHeight}`;
            document.getElementById('statSavings').textContent = `${savings}%`;

            // åº”ç”¨å½“å‰ç¼©æ”¾
            applyTransform();
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // ä¿å­˜å‹ç¼©åå›¾ç‰‡çš„å°ºå¯¸
        let compressedWidth = 0;
        let compressedHeight = 0;

        // --- ç¼©æ”¾å’Œæ‹–æ‹½æ§åˆ¶ ---
        function adjustZoom(delta) {
            setZoom(currentZoom + delta);
        }

        function setZoom(level) {
            currentZoom = Math.max(0.25, Math.min(10, level));
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
            applyTransform();
        }

        function resetZoom() {
            // ä½¿ç”¨å‹ç¼©åå›¾ç‰‡å°ºå¯¸æ¥è®¡ç®—é€‚åº”è§†å£çš„ç¼©æ”¾æ¯”ä¾‹
            const viewport = document.getElementById('compressedViewport');
            if (!viewport) return;

            // ä½¿ç”¨å‹ç¼©åçš„å°ºå¯¸ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨åŸå›¾å°ºå¯¸
            const imgWidth = compressedWidth || (originalImageObj ? originalImageObj.width : 1024);
            const imgHeight = compressedHeight || (originalImageObj ? originalImageObj.height : 1024);

            const viewportRect = viewport.getBoundingClientRect();
            const scaleX = viewportRect.width / imgWidth;
            const scaleY = viewportRect.height / imgHeight;
            const fitScale = Math.min(scaleX, scaleY, 1) * 0.9;

            panOffset = { x: 0, y: 0 };
            setZoom(fitScale);
        }

        function applyTransform() {
            const originalImg = document.getElementById('originalPreview');
            const compressedImg = document.getElementById('compressedPreview');

            // å‹ç¼©åå›¾ç‰‡ä½¿ç”¨å½“å‰ç¼©æ”¾
            const compressedTransform = `scale(${currentZoom}) translate(${panOffset.x}px, ${panOffset.y}px)`;
            if (compressedImg) compressedImg.style.transform = compressedTransform;

            // åŸå›¾éœ€è¦è®¡ç®—ç›¸å¯¹äºå‹ç¼©å›¾çš„ç¼©æ”¾æ¯”ä¾‹ï¼Œä»¥ä¿æŒè§†è§‰ä¸€è‡´
            if (originalImg && originalImageObj && compressedWidth > 0 && compressedHeight > 0) {
                // è®¡ç®—åŸå›¾ä¸å‹ç¼©å›¾çš„å°ºå¯¸æ¯”ä¾‹
                const sizeRatio = compressedWidth / originalImageObj.width;
                // åŸå›¾çš„å®é™…ç¼©æ”¾ = å‹ç¼©å›¾ç¼©æ”¾ Ã— å°ºå¯¸æ¯”ä¾‹
                const originalZoom = currentZoom * sizeRatio;
                const originalTransform = `scale(${originalZoom}) translate(${panOffset.x / sizeRatio}px, ${panOffset.y / sizeRatio}px)`;
                originalImg.style.transform = originalTransform;
            } else if (originalImg) {
                originalImg.style.transform = compressedTransform;
            }
        }

        function toggleSyncZoom() {
            syncZoomEnabled = document.querySelector('#syncToggle input').checked;
            document.getElementById('syncToggle').classList.toggle('active', syncZoomEnabled);
        }

        function setupViewportInteractions() {
            const viewports = document.querySelectorAll('.image-viewport');

            viewports.forEach(viewport => {
                // é¼ æ ‡æ»šè½®ç¼©æ”¾
                viewport.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -0.1 : 0.1;
                    adjustZoom(delta);
                }, { passive: false });

                // æ‹–æ‹½ç§»åŠ¨
                viewport.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    dragStart = { x: e.clientX - panOffset.x * currentZoom, y: e.clientY - panOffset.y * currentZoom };
                    viewport.style.cursor = 'grabbing';
                });

                viewport.addEventListener('mousemove', (e) => {
                    if (!isDragging) return;
                    panOffset.x = (e.clientX - dragStart.x) / currentZoom;
                    panOffset.y = (e.clientY - dragStart.y) / currentZoom;
                    applyTransform();
                });

                viewport.addEventListener('mouseup', () => {
                    isDragging = false;
                    viewport.style.cursor = 'grab';
                });

                viewport.addEventListener('mouseleave', () => {
                    isDragging = false;
                    viewport.style.cursor = 'grab';
                });
            });
        }

        // æ¸²æŸ“é¢„è§ˆç½‘æ ¼
        function renderPreviews() {
            const grid = document.getElementById('previewGrid');
            const placeholder = document.getElementById('uploadPlaceholder');
            const badge = document.getElementById('imgCountBadge');

            grid.innerHTML = '';

            if (referenceImages.length > 0) {
                placeholder.style.display = 'none';
            } else {
                placeholder.style.display = 'block';
            }

            referenceImages.forEach((base64, index) => {
                const div = document.createElement('div');
                div.className = 'thumb-item';
                div.onclick = (e) => e.stopPropagation(); // é˜²æ­¢ç‚¹å‡»å›¾ç‰‡è§¦å‘ä¸Šä¼ æ¡†

                const img = document.createElement('img');
                img.src = base64;

                const btn = document.createElement('button');
                btn.className = 'thumb-remove';
                btn.innerHTML = 'Ã—';
                btn.onclick = (e) => {
                    e.stopPropagation(); // é˜²æ­¢å†’æ³¡
                    removeImage(index);
                };

                div.appendChild(img);
                div.appendChild(btn);
                grid.appendChild(div);
            });

            badge.innerText = `${referenceImages.length} / ${MAX_IMAGES}`;
        }

        function removeImage(index) {
            referenceImages.splice(index, 1);
            renderPreviews();
            log("å·²ç§»é™¤ä¸€å¼ å‚è€ƒå›¾");
        }

        // æ ‡è®°æ˜¯å¦ä¸ºå›ç¯æ¨¡å¼ï¼ˆæ¸…ç©ºç°æœ‰åˆ—è¡¨åæ·»åŠ ï¼‰
        let isLoopMode = false;

        // --- ä¿®æ”¹ï¼šå›ç¯åŠŸèƒ½ (æ¸…ç©ºåˆ—è¡¨å¹¶æ·»åŠ å½“å‰ç»“æœ) ---
        async function useResultAsSource() {
            const resultImg = document.getElementById('resultImage');
            if (!resultImg.src) return;

            log("æ­£åœ¨å¤„ç†...å°†æ¸…ç©ºç°æœ‰å‚è€ƒå›¾å¹¶å°†æ­¤å›¾åŠ å…¥åˆ—è¡¨ã€‚");

            try {
                const response = await fetch(resultImg.src);
                const blob = await response.blob();
                const reader = new FileReader();
                reader.onloadend = () => {
                    // è®¾ç½®å›ç¯æ¨¡å¼æ ‡å¿—
                    isLoopMode = true;

                    // å°†ç»“æœå›¾ä½œä¸º base64 æ‰“å¼€å‹ç¼©å¯¹è¯æ¡†
                    currentOriginalBase64 = reader.result;
                    openCompressModal(reader.result);

                    log("æ‰“å¼€å‹ç¼©è®¾ç½®å¯¹è¯æ¡†...");
                };
                reader.readAsDataURL(blob);
            } catch (e) {
                log(`å›ç¯å¤±è´¥ (å¯èƒ½å› è·¨åŸŸé™åˆ¶): ${e.message}`, 'error');
            }
        }

        // --- æ–°å¢ï¼šæ’­æ”¾å®Œæˆæç¤ºéŸ³ ---
        function playCompletionSound() {
            if ('speechSynthesis' in window) {
                // åˆ›å»ºä¸€ä¸ªæ–°çš„è¯­éŸ³è¯·æ±‚
                const utterance = new SpeechSynthesisUtterance("å›¾ç‰‡å·²ç”Ÿæˆå®Œæˆ");
                // è®¾ç½®è¯­è¨€ä¸ºä¸­æ–‡
                utterance.lang = 'zh-CN';
                // è®¾ç½®éŸ³é‡ä¸ºæœ€å¤§ (0 åˆ° 1)
                utterance.volume = 1.0;
                // è®¾ç½®é€Ÿç‡ (0.1 åˆ° 10, é»˜è®¤ 1)
                utterance.rate = 1.0;
                // è®¾ç½®éŸ³è°ƒ (0 åˆ° 2, é»˜è®¤ 1)
                utterance.pitch = 1.0;

                window.speechSynthesis.speak(utterance);
            } else {
                log("æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆï¼Œæ— æ³•æ’­æ”¾æç¤ºéŸ³ã€‚", 'warn');
            }
        }
        // -----------------------


        // --- 3. æ ¸å¿ƒè¯·æ±‚é€»è¾‘ (æ”¯æŒå¤šæ¨¡æ€) ---
        function log(msg, type = 'info') {
            const consoleEl = document.getElementById('logConsole');
            const color = type === 'error' ? '#e74c3c' : (type === 'success' ? '#2ecc71' : (type === 'warn' ? '#f39c12' : '#00ff00'));
            consoleEl.innerHTML += `<div style="color:${color}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        // AOD æ¨¡å¼ç›¸å…³å‡½æ•°
        let aodTimeoutId = null;
        let aodOverlay = null;
        let aodTextBlock = null;
        let aodAnimationId = null;
        let aodTimeUpdateId = null;
        let wakeLock = null;
        let noSleepVideo = null;
        let requestStartTime = null;
        let isRequestInProgress = false;
        let originalThemeColor = null;
        let noSleepVideoInitialized = false;
        let isVideoPlayingForRequest = false;
        let keepAwakeAudioContext = null;
        let videoCheckIntervalId = null;
        let videoAnimationFrameId = null;

        async function initNoSleepVideo() {
            if (noSleepVideoInitialized && noSleepVideo) return;

            try {
                noSleepVideo = document.createElement('video');
                noSleepVideo.setAttribute('playsinline', '');
                noSleepVideo.setAttribute('webkit-playsinline', '');
                noSleepVideo.muted = true;
                noSleepVideo.loop = true;

                // è®¾ç½®ä¸€ä¸ªé€æ˜çš„2x2åƒç´ è§†é¢‘
                const canvas = document.createElement('canvas');
                canvas.width = 2;
                canvas.height = 2;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, 2, 2);

                // åˆ›å»ºå¸¦æœ‰éŸ³é¢‘è½¨é“çš„MediaStreamä»¥æé«˜iOSå…¼å®¹æ€§
                let stream;
                try {
                    // å°è¯•åˆ›å»ºå¸¦æœ‰éŸ³é¢‘è½¨é“çš„æµ
                    const canvasStream = canvas.captureStream();
                    if (typeof MediaStream !== 'undefined' && 'getAudioTracks' in canvasStream) {
                        // å¦‚æœæ”¯æŒï¼Œæ·»åŠ ä¸€ä¸ªé™éŸ³éŸ³é¢‘è½¨é“
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const destination = audioContext.createMediaStreamDestination();
                        oscillator.connect(destination);
                        oscillator.start();

                        // åˆå¹¶è§†é¢‘å’ŒéŸ³é¢‘è½¨é“
                        const audioTrack = destination.stream.getAudioTracks()[0];
                        const videoTrack = canvasStream.getVideoTracks()[0];
                        stream = new MediaStream([videoTrack, audioTrack]);

                        // ç«‹å³å…³é—­éŸ³é¢‘ä¸Šä¸‹æ–‡ä»¥é¿å…å ç”¨èµ„æº
                        oscillator.stop();
                        audioContext.close();
                    } else {
                        stream = canvasStream;
                    }
                } catch (e) {
                    // å›é€€åˆ°åŸå§‹canvasæµ
                    stream = canvas.captureStream();
                }

                noSleepVideo.srcObject = stream;

                // å°†è§†é¢‘æ”¾åœ¨å³ä¸‹è§’ï¼Œæä½é€æ˜åº¦ä½†ä»åœ¨è§†å£å†…
                noSleepVideo.style.position = 'fixed';
                noSleepVideo.style.bottom = '0';
                noSleepVideo.style.right = '0';
                noSleepVideo.style.width = '2px';
                noSleepVideo.style.height = '2px';
                noSleepVideo.style.opacity = '0.001'; // æ›´ä½çš„é€æ˜åº¦
                noSleepVideo.style.pointerEvents = 'none';
                noSleepVideo.style.zIndex = '-9999';
                noSleepVideo.style.visibility = 'hidden'; // å®Œå…¨éšè—ä½†ä»åœ¨DOMä¸­
                document.body.appendChild(noSleepVideo);

                // åœ¨ç”¨æˆ·äº¤äº’æœŸé—´ç«‹å³æ’­æ”¾å¹¶æŒç»­æ’­æ”¾
                await noSleepVideo.play();
                noSleepVideoInitialized = true;
                console.log('è§†é¢‘é˜²æ¯å±é¢„åˆå§‹åŒ–å¹¶å¼€å§‹æ’­æ”¾');
            } catch (e) {
                console.error('è§†é¢‘é˜²æ¯å±åˆå§‹åŒ–å¤±è´¥:', e);
                // å¦‚æœæ’­æ”¾å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ä¸€ä¸ªçœŸå®çš„è§†é¢‘æº
                if (noSleepVideo) {
                    try {
                        noSleepVideo.srcObject = null;
                        noSleepVideo.src = 'data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28yYXZjMW1wNDEAAAAIZnJlZQAAAKxtZGF0AAAAsAAAAF4AAAIAAQABABAABAAXAAEAAgACAAUABAAAAAIAAAAAAB9pbHN0AAAA8AAAACxpbmVmAAAARAAAAB5pbmVsIAAAAEQAAAAIc3RibAAAAJwAAACEc3RzZAAAAJwAAAAYbXA0MQAAABQAAAAgbWRhdAAAAKwAAAAY';
                        noSleepVideo.load();
                        await noSleepVideo.play();
                        noSleepVideoInitialized = true;
                        console.log('å¤‡ç”¨è§†é¢‘é˜²æ¯å±é¢„åˆå§‹åŒ–å¹¶å¼€å§‹æ’­æ”¾');
                    } catch (e2) {
                        console.error('å¤‡ç”¨è§†é¢‘ä¹Ÿå¤±è´¥:', e2);
                    }
                }
            }
        }

        function enterAODMode() {
            // é˜²æ­¢é‡å¤è¿›å…¥
            if (document.querySelector('.aod-overlay')) return;

            // å¦‚æœè¯·æ±‚æœªè¿›è¡Œä¸­ï¼Œä¸è¿›å…¥AODæ¨¡å¼
            if (!isRequestInProgress) return;

            // è·å–æœ€æ–°æ—¥å¿—
            const consoleEl = document.getElementById('logConsole');
            const logItems = consoleEl.querySelectorAll('div');
            if (logItems.length === 0) return;

            const lastLog = logItems[logItems.length - 1];
            const logText = lastLog.textContent || lastLog.innerText;

            // è§£ææ—¶é—´æ ‡è¯†å’Œæ¶ˆæ¯
            const timeMatch = logText.match(/^\[(.*?)\]\s*(.*)/);
            if (!timeMatch) return;

            const timePart = `[${timeMatch[1]}] `;
            const message = timeMatch[2];
            const width = timePart.length; // å­—ç¬¦å®½åº¦

            // å°†æ¶ˆæ¯æŒ‰å®½åº¦æ¢è¡ŒæˆçŸ©å½¢å—
            let lines = [];
            for (let i = 0; i < message.length; i += width) {
                lines.push(message.substring(i, i + width));
            }
            // ç¡®ä¿çŸ©å½¢é«˜åº¦è‡³å°‘ä¸º3è¡Œ
            while (lines.length < 3) {
                lines.push(' '.repeat(width));
            }
            // ç¡®ä¿æ¯è¡Œå®½åº¦ä¸€è‡´
            lines = lines.map(line => line.padEnd(width, ' '));

            const blockText = lines.join('\n');

            // è®¾ç½®bodyæ ·å¼é˜²æ­¢æ»šåŠ¨
            document.body.style.overflow = 'hidden';
            document.body.style.height = '100vh';
            document.documentElement.style.height = '100vh';
            document.documentElement.style.overflow = 'hidden';

            // ä¿®æ”¹ä¸»é¢˜é¢œè‰²ä¸ºé»‘è‰²ä»¥åŒ¹é…AODæ¨¡å¼
            const themeColorMeta = document.querySelector('meta[name="theme-color"]');
            if (themeColorMeta) {
                originalThemeColor = themeColorMeta.getAttribute('content');
                themeColorMeta.setAttribute('content', '#000000');
            }

            // åˆ›å»ºè¦†ç›–å±‚
            aodOverlay = document.createElement('div');
            aodOverlay.className = 'aod-overlay';

            // åˆ›å»ºæ—¶é—´æ˜¾ç¤º
            const timeDisplay = document.createElement('div');
            timeDisplay.className = 'aod-time-display';
            timeDisplay.id = 'aodTimeDisplay';
            // æ—¶é—´æ˜¾ç¤ºå°†æ·»åŠ åˆ°æ–‡æœ¬å—å†…éƒ¨

            aodTextBlock = document.createElement('div');
            aodTextBlock.className = 'aod-text-block';
            aodTextBlock.textContent = blockText;
            aodTextBlock.appendChild(timeDisplay);
            aodOverlay.appendChild(aodTextBlock);
            document.body.appendChild(aodOverlay);

            // æ›´æ–°æ—¶é—´æ˜¾ç¤º
            function updateTimeDisplay() {
                if (!requestStartTime || !isRequestInProgress) return;
                const elapsed = Date.now() - requestStartTime;
                const seconds = Math.floor(elapsed / 1000);
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                const timeText = `è¯·æ±‚å·²è¿è¡Œ: ${minutes > 0 ? `${minutes}åˆ†` : ''}${remainingSeconds}ç§’`;
                timeDisplay.textContent = timeText;
            }

            // åˆå§‹æ›´æ–°å¹¶è®¾ç½®å®šæ—¶å™¨
            updateTimeDisplay();
            aodTimeUpdateId = setInterval(updateTimeDisplay, 1000);

            // å¯åŠ¨DVDåŠ¨ç”»
            startDVDAnimation(aodTextBlock);

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼šé€€å‡ºAODæ¨¡å¼å¹¶é‡æ–°å¯åŠ¨æ£€æµ‹
            aodOverlay.addEventListener('click', function() {
                exitAODMode();
                // å¦‚æœè¯·æ±‚è¿˜åœ¨è¿›è¡Œä¸­ï¼Œé‡æ–°å¯åŠ¨5ç§’æ£€æµ‹
                if (isRequestInProgress) {
                    const elapsed = Date.now() - requestStartTime;
                    let remaining = Math.max(0, 5000 - elapsed);
                    // ç¡®ä¿è‡³å°‘æœ‰2ç§’çš„é—´éš”ï¼Œé¿å…ç«‹å³é‡æ–°è¿›å…¥
                    if (remaining < 2000) {
                        remaining = 2000;
                    }
                    aodTimeoutId = setTimeout(() => {
                        enterAODMode();
                    }, remaining);
                }
            });

            // é˜»æ­¢æ¯å±
            preventScreenSleep();
        }

        function exitAODMode(requestCompleted = false) {
            // æ¸…é™¤å®šæ—¶å™¨
            if (aodTimeoutId) {
                clearTimeout(aodTimeoutId);
                aodTimeoutId = null;
            }

            // åœæ­¢åŠ¨ç”»
            if (aodAnimationId) {
                cancelAnimationFrame(aodAnimationId);
                aodAnimationId = null;
            }

            // æ¸…é™¤æ—¶é—´æ›´æ–°å®šæ—¶å™¨
            if (aodTimeUpdateId) {
                clearInterval(aodTimeUpdateId);
                aodTimeUpdateId = null;
            }

            // ç§»é™¤è¦†ç›–å±‚
            if (aodOverlay && aodOverlay.parentNode) {
                aodOverlay.parentNode.removeChild(aodOverlay);
                aodOverlay = null;
                aodTextBlock = null;
            }

            // å…è®¸æ¯å±
            allowScreenSleep();

            // æ¢å¤bodyæ ·å¼
            document.body.style.overflow = '';
            document.body.style.height = '';
            document.documentElement.style.height = '';
            document.documentElement.style.overflow = '';

            // æ¢å¤ä¸»é¢˜é¢œè‰²
            const themeColorMeta = document.querySelector('meta[name="theme-color"]');
            if (themeColorMeta && originalThemeColor) {
                themeColorMeta.setAttribute('content', originalThemeColor);
            }

            // å¦‚æœè¯·æ±‚å·²å®Œæˆï¼Œæ›´æ–°çŠ¶æ€
            if (requestCompleted) {
                isRequestInProgress = false;
                // è¯·æ±‚å®Œæˆï¼Œåœæ­¢è§†é¢‘é˜²æ¯å±
                isVideoPlayingForRequest = false;
                if (noSleepVideo) {
                    noSleepVideo.pause();
                    console.log('è§†é¢‘é˜²æ¯å±å·²æš‚åœï¼ˆè¯·æ±‚å®Œæˆï¼‰');
                }
            }
        }

        function startDVDAnimation(element) {
            const rect = element.getBoundingClientRect();
            const parent = element.parentElement;
            const parentRect = parent.getBoundingClientRect();

            // åˆå§‹ä½ç½®éšæœºï¼ˆåœ¨çˆ¶å®¹å™¨å†…ï¼‰
            let x = Math.random() * (parentRect.width - rect.width);
            let y = Math.random() * (parentRect.height - rect.height);

            // åˆå§‹é€Ÿåº¦æ–¹å‘éšæœºï¼Œé€Ÿåº¦è¾ƒæ…¢
            let angle = Math.random() * Math.PI * 2;
            let speed = 0.2; // åƒç´ /æ¯«ç§’ï¼ˆè¾ƒæ…¢é€Ÿåº¦ï¼‰
            let vx = Math.cos(angle) * speed;
            let vy = Math.sin(angle) * speed;

            let lastTime = performance.now();

            function animate(currentTime) {
                const deltaTime = currentTime - lastTime;
                lastTime = currentTime;

                // åŸºäºæ—¶é—´æ›´æ–°ä½ç½®
                x += vx * deltaTime;
                y += vy * deltaTime;

                // è¾¹ç•Œç¢°æ’æ£€æµ‹å’Œåå¼¹
                let bounced = false;

                if (x <= 0) {
                    x = 0;
                    vx = Math.abs(vx); // åå¼¹ï¼Œä¿æŒé€Ÿåº¦å¤§å°
                    bounced = true;
                } else if (x + rect.width >= parentRect.width) {
                    x = parentRect.width - rect.width;
                    vx = -Math.abs(vx);
                    bounced = true;
                }

                if (y <= 0) {
                    y = 0;
                    vy = Math.abs(vy);
                    bounced = true;
                } else if (y + rect.height >= parentRect.height) {
                    y = parentRect.height - rect.height;
                    vy = -Math.abs(vy);
                    bounced = true;
                }

                // å¦‚æœå‘ç”Ÿç¢°æ’ï¼Œè½»å¾®éšæœºåŒ–è§’åº¦
                if (bounced) {
                    const angleChange = (Math.random() - 0.5) * 0.2; // å°è§’åº¦å˜åŒ–
                    const currentAngle = Math.atan2(vy, vx);
                    const newAngle = currentAngle + angleChange;
                    const currentSpeed = Math.sqrt(vx*vx + vy*vy);
                    vx = Math.cos(newAngle) * currentSpeed;
                    vy = Math.sin(newAngle) * currentSpeed;
                }

                // åº”ç”¨transformå®ç°ç¡¬ä»¶åŠ é€Ÿ
                element.style.transform = `translate(${x}px, ${y}px)`;

                aodAnimationId = requestAnimationFrame(animate);
            }

            // è®¾ç½®åˆå§‹ä½ç½®
            element.style.position = 'absolute';
            element.style.left = '0';
            element.style.top = '0';
            element.style.transform = `translate(${x}px, ${y}px)`;

            aodAnimationId = requestAnimationFrame(animate);
        }

        async function preventScreenSleep() {
            // æ–¹æ³•1: ä½¿ç”¨Wake Lock APIï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('å±å¹•å”¤é†’é”å®šå·²æ¿€æ´»');
                } catch (err) {
                    console.error(`å”¤é†’é”å®šå¤±è´¥: ${err.message}`);
                }
            }

            // æ–¹æ³•2: è§†é¢‘é˜²æ¯å±ï¼ˆiOSç­‰ä¸æ”¯æŒWake Lockçš„å¹³å°ï¼‰
            try {
                // å¦‚æœè§†é¢‘æœªåˆå§‹åŒ–ï¼Œå…ˆåˆå§‹åŒ–
                if (!noSleepVideoInitialized || !noSleepVideo) {
                    await initNoSleepVideo();
                }

                // æ’­æ”¾å·²åˆå§‹åŒ–çš„è§†é¢‘
                if (noSleepVideo) {
                    await noSleepVideo.play();
                    console.log('è§†é¢‘é˜²æ¯å±å·²æ¿€æ´»');

                    // æ¸…é™¤å·²æœ‰çš„å®šæ—¶å™¨
                    if (videoCheckIntervalId) {
                        clearInterval(videoCheckIntervalId);
                    }
                    // è®¾ç½®å®šæ—¶å™¨å®šæœŸæ£€æŸ¥è§†é¢‘çŠ¶æ€
                    videoCheckIntervalId = setInterval(() => {
                        if (noSleepVideo && noSleepVideo.paused) {
                            console.log('è§†é¢‘å·²æš‚åœï¼Œé‡æ–°æ’­æ”¾');
                            noSleepVideo.play().catch(e => console.error('è§†é¢‘é‡æ–°æ’­æ”¾å¤±è´¥:', e));
                        }
                    }, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡

                    // ä½¿ç”¨requestAnimationFrameè¿›è¡Œæ›´é¢‘ç¹çš„çŠ¶æ€æ£€æŸ¥ï¼ˆé’ˆå¯¹iOSï¼‰
                    function checkVideoAnimationFrame() {
                        if (noSleepVideo && noSleepVideo.paused) {
                            console.log('è§†é¢‘æš‚åœï¼ˆåŠ¨ç”»å¸§æ£€æµ‹ï¼‰ï¼Œé‡æ–°æ’­æ”¾');
                            noSleepVideo.play().catch(e => console.error('è§†é¢‘é‡æ–°æ’­æ”¾å¤±è´¥ï¼ˆåŠ¨ç”»å¸§ï¼‰:', e));
                        }
                        videoAnimationFrameId = requestAnimationFrame(checkVideoAnimationFrame);
                    }
                    videoAnimationFrameId = requestAnimationFrame(checkVideoAnimationFrame);
                }
            } catch (e) {
                console.error('è§†é¢‘é˜²æ¯å±æ’­æ”¾å¤±è´¥:', e);
            }

            // æ–¹æ³•3: Web Audio APIé˜²æ¯å±ï¼ˆiOS/Safariï¼‰
            if (!keepAwakeAudioContext && window.AudioContext) {
                try {
                    keepAwakeAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                    // åˆ›å»ºé™éŸ³éŸ³é¢‘æº
                    const oscillator = keepAwakeAudioContext.createOscillator();
                    const gainNode = keepAwakeAudioContext.createGain();
                    gainNode.gain.value = 0; // å®Œå…¨é™éŸ³
                    oscillator.connect(gainNode);
                    gainNode.connect(keepAwakeAudioContext.destination);
                    oscillator.start();
                    console.log('éŸ³é¢‘é˜²æ¯å±å·²æ¿€æ´»');
                } catch (e) {
                    console.error('éŸ³é¢‘é˜²æ¯å±åˆå§‹åŒ–å¤±è´¥:', e);
                }
            }
        }

        function allowScreenSleep() {
            if (wakeLock) {
                wakeLock.release().then(() => {
                    wakeLock = null;
                    console.log('å±å¹•å”¤é†’é”å®šå·²é‡Šæ”¾');
                });
            }
            if (noSleepVideo && !isVideoPlayingForRequest) {
                noSleepVideo.pause();
                // ä¸æ¸…é™¤è§†é¢‘ï¼Œä»¥ä¾¿é‡æ–°æ’­æ”¾
                console.log('è§†é¢‘é˜²æ¯å±å·²æš‚åœï¼ˆéè¯·æ±‚æœŸé—´ï¼‰');
            }
            // æ¸…é™¤è§†é¢‘æ£€æŸ¥å®šæ—¶å™¨
            if (videoCheckIntervalId) {
                clearInterval(videoCheckIntervalId);
                videoCheckIntervalId = null;
                console.log('è§†é¢‘æ£€æŸ¥å®šæ—¶å™¨å·²æ¸…é™¤');
            }
            // æ¸…é™¤è§†é¢‘åŠ¨ç”»å¸§
            if (videoAnimationFrameId) {
                cancelAnimationFrame(videoAnimationFrameId);
                videoAnimationFrameId = null;
                console.log('è§†é¢‘åŠ¨ç”»å¸§æ£€æŸ¥å·²æ¸…é™¤');
            }
            // å…³é—­éŸ³é¢‘ä¸Šä¸‹æ–‡
            if (keepAwakeAudioContext) {
                keepAwakeAudioContext.close().then(() => {
                    keepAwakeAudioContext = null;
                    console.log('éŸ³é¢‘é˜²æ¯å±å·²é‡Šæ”¾');
                }).catch(e => {
                    console.error('éŸ³é¢‘ä¸Šä¸‹æ–‡å…³é—­å¤±è´¥:', e);
                    keepAwakeAudioContext = null;
                });
            }
        }

        async function generateImage() {
            const baseUrl = document.getElementById('baseUrl').value.replace(/\/+$/, "");
            const apiKey = document.getElementById('apiKey').value.trim();
            const model = document.getElementById('modelName').value.trim();
            const prompt = document.getElementById('prompt').value.trim();

            if (!apiKey) return log("è¯·å…ˆå¡«å†™ API Key", 'error');
            if (!prompt) return log("è¯·å¡«å†™æç¤ºè¯", 'error');

            // UI çŠ¶æ€
            const btn = document.getElementById('generateBtn');
            const spinner = document.getElementById('spinner');
            const resultImg = document.getElementById('resultImage');
            const loopBtn = document.getElementById('loopBtn');
            const phText = document.getElementById('placeholderText');

            btn.disabled = true;
            btn.innerText = "ç”Ÿæˆä¸­...";
            spinner.style.display = 'block';
            phText.style.display = 'none';
            resultImg.style.display = 'none';
            loopBtn.style.display = 'none';

            // é¢„åˆå§‹åŒ–è§†é¢‘é˜²æ¯å±ï¼ˆåœ¨ç”¨æˆ·äº¤äº’æœŸé—´ï¼‰
            initNoSleepVideo().catch(() => {});
            // è®¾ç½®è§†é¢‘é˜²æ¯å±ä¸ºè¯·æ±‚æ¨¡å¼
            isVideoPlayingForRequest = true;
            // ç¡®ä¿è§†é¢‘åœ¨æ’­æ”¾
            if (noSleepVideo && noSleepVideo.paused) {
                noSleepVideo.play().catch(e => console.error('è§†é¢‘æ’­æ”¾å¤±è´¥:', e));
            }

            // è®¾ç½®è¯·æ±‚çŠ¶æ€
            requestStartTime = Date.now();
            isRequestInProgress = true;

            try {
                let url, payload;

                // ç­–ç•¥é€‰æ‹©
                if (referenceImages.length > 0) {
                    // Mode A: Chat Vision (å¤šå›¾æ¨¡å¼)
                    log(`ä½¿ç”¨ Chat Vision æ¨¡å¼ (å‚è€ƒå›¾æ•°é‡: ${referenceImages.length})...`);
                    url = `${baseUrl}/v1/chat/completions`;

                    // æ„å»ºå¤šæ¨¡æ€ content æ•°ç»„
                    const contentArray = [
                        { type: "text", text: prompt + " \n\n (Please generate an image based on the provided images and this description. Return the image URL ONLY.)" }
                    ];

                    // å¾ªç¯æ·»åŠ æ‰€æœ‰å›¾ç‰‡
                    referenceImages.forEach(base64 => {
                        contentArray.push({
                            type: "image_url",
                            image_url: { url: base64 }
                        });
                    });

                    payload = {
                        model: model,
                        messages: [
                            {
                                role: "user",
                                content: contentArray
                            }
                        ],
                        max_tokens: 4096
                    };
                } else {
                    // Mode B: æ ‡å‡† Image Gen (çº¯æ–‡)
                    log("ä½¿ç”¨æ ‡å‡† Image Generations æ¨¡å¼...");
                    url = `${baseUrl}/v1/images/generations`;
                    payload = {
                        model: model,
                        prompt: prompt,
                        n: 1,
                        size: "1024x1024"
                    };
                }

                log(`å‘é€ POST è¯·æ±‚...`);

                // è®¾ç½®5ç§’è¶…æ—¶ï¼Œè¿›å…¥AODæ¨¡å¼
                aodTimeoutId = setTimeout(() => {
                    enterAODMode();
                }, 5000);

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                // æ¸…é™¤AODå®šæ—¶å™¨
                if (aodTimeoutId) {
                    clearTimeout(aodTimeoutId);
                    aodTimeoutId = null;
                }

                if (!response.ok) {
                    log("API è¿”å›é”™è¯¯ä¿¡æ¯: " + JSON.stringify(data), 'error');
                    throw new Error(data.error?.message || `HTTP ${response.status}`);
                }

                let finalImageUrl = null;

                // è§£æå“åº”
                if (data.data && data.data[0]?.url) {
                    finalImageUrl = data.data[0].url; // æ ‡å‡† Image æ¥å£
                } else if (data.choices && data.choices[0]?.message?.content) {
                    // Chat æ¥å£
                    const content = data.choices[0].message.content;
                    log("æ”¶åˆ° Chat å“åº”ï¼Œè§£æä¸­...");

                    const mdMatch = content.match(/\!\[.*?\]\((https?:\/\/[^\s\)]+)\)/);
                    const urlMatch = content.match(/(https?:\/\/[^\s\)]+(?:\.png|\.jpg|\.jpeg|\.webp|\?[\w=&]+)?)/i);

                    if (mdMatch) finalImageUrl = mdMatch[1];
                    else if (urlMatch) finalImageUrl = urlMatch[1];
                    else {
                        log("âŒ æœªæ£€æµ‹åˆ°å›¾ç‰‡é“¾æ¥ï¼Œæ¨¡å‹åŸå§‹å†…å®¹:", 'error');
                        log(content, 'warn');
                        phText.innerText = "æ¨¡å‹æœªè¿”å›å›¾ç‰‡é“¾æ¥";
                        phText.style.display = 'block';
                        exitAODMode(true);
                    }
                }

                if (finalImageUrl) {
                    log("è·å–å›¾ç‰‡ URLï¼Œæ¸²æŸ“ä¸­...");
                    resultImg.src = finalImageUrl;
                    resultImg.onload = () => {
                        log("âœ… å›¾ç‰‡ç”ŸæˆæˆåŠŸ", 'success');
                        resultImg.style.display = 'block';
                        loopBtn.style.display = 'inline-block';
                        spinner.style.display = 'none';
                        btn.disabled = false;
                        btn.innerText = "ğŸš€ å¼€å§‹ç”Ÿæˆå›¾ç‰‡";
                        // --- æ–°å¢ï¼šè°ƒç”¨æ’­æ”¾å£°éŸ³å‡½æ•° ---
                        playCompletionSound();
                        // -------------------------
                        exitAODMode(true);
                    };
                    resultImg.onerror = () => {
                        log("âŒ å›¾ç‰‡åŠ è½½å¤±è´¥", 'error');
                        spinner.style.display = 'none';
                        btn.disabled = false;
                        btn.innerText = "ğŸš€ å¼€å§‹ç”Ÿæˆå›¾ç‰‡";
                        exitAODMode(true);
                    };
                } else if (!phText.style.display || phText.style.display === 'none') {
                    spinner.style.display = 'none';
                    btn.disabled = false;
                    btn.innerText = "ğŸš€ å¼€å§‹ç”Ÿæˆå›¾ç‰‡";
                    exitAODMode(true);
                } else {
                    spinner.style.display = 'none';
                    btn.disabled = false;
                    btn.innerText = "ğŸš€ å¼€å§‹ç”Ÿæˆå›¾ç‰‡";
                    exitAODMode(true);
                }

            } catch (error) {
                // æ¸…é™¤AODå®šæ—¶å™¨å¹¶é€€å‡ºAODæ¨¡å¼
                if (aodTimeoutId) {
                    clearTimeout(aodTimeoutId);
                    aodTimeoutId = null;
                }
                exitAODMode(true);
                log(`âŒ æ‰§è¡Œå‡ºé”™: ${error.message}`, 'error');
                spinner.style.display = 'none';
                btn.disabled = false;
                btn.innerText = "ğŸš€ å¼€å§‹ç”Ÿæˆå›¾ç‰‡";
                phText.style.display = 'block';
                phText.innerText = "è¯·æ±‚å‡ºé”™ï¼Œè¯·æ£€æŸ¥æ—¥å¿—";
            }
        }
    </script>

</body>

</html>